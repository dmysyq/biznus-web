@model Product
@{
    ViewData["Title"] = Model.Name;
}

<!-- Заголовок страницы -->
<div class="page-title-section">
    <div class="container">
        <h1 class="page-title">@Model.Name</h1>
    </div>
</div>

<!-- Основная секция товара -->
<div class="content-section">
    <div class="container">
        <div class="shopping-page-wrapper">
            <div class="shopping-page-left">
                <div style="background-image:url('@Url.Content(Model.ImageUrl)')" class="shopping-page-image">
                    @if (Model.Price < 100)
                    {
                        <div class="pill-2 badge primary sale">Sale</div>
                    }
                </div>
            </div>
            <div class="shipping-page-right">
                <h2 class="page-product-headin">@Model.Name</h2>
                <div class="page-price-wrapping">
                    <div class="shop-item-price-page">$@Model.Price.ToString("F2") USD</div>
                </div>
                <div>
                    @if (Model.IsAvailable)
                    {
                        <form asp-controller="Cart" asp-action="Add" method="post" class="w-commerce-commerceaddtocartform" id="addToCartForm-@Model.Id">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@Model.Id" />
                            <label for="quantity-@Model.Id">Quantity</label>
                            <div class="add-to-cart-page-wrapper">
                                <input type="number" pattern="^[0-9]+$" inputMode="numeric" id="quantity-@Model.Id" name="quantity" min="1" class="w-commerce-commerceaddtocartquantityinput input cart-quantity" value="1" />
                                <button type="submit" class="w-commerce-commerceaddtocartbutton btn outline">Add to Cart</button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="w-commerce-commerceaddtocartoutofstock" tabindex="0">
                            <div>Out of Stock</div>
                        </div>
                    }
                </div>
                <div class="w-richtext">
                    <h2>Product Description</h2>
                    <p>@Model.Description</p>
                    <h4>Product Details</h4>
                    <p>This is a high-quality @(Model.Category?.ToLower() ?? "product") that will meet all your outdoor needs. Perfect for camping, hiking, and other outdoor adventures.</p>
                    <h4>Features</h4>
                    <p>• Durable construction<br/>
                    • Weather resistant<br/>
                    • Easy to set up<br/>
                    • Lifetime warranty</p>
                </div>
                <div>
                    <h3 class="page-product-headin">Tweet about #AcmeOutdoors products</h3>
                    <div class="w-widget w-widget-twitter">
                        <iframe title="Twitter Tweet Button" src="//platform.twitter.com/widgets/tweet_button.html#url=http%3A%2F%2Fbiznus-template.io&amp;counturl=biznus-template.io&amp;text=You'll%20love%20the%20@Model.Name%20from%20Acme%20Outdoors!&amp;show_count=false&amp;dnt=true&amp;size=l&amp;width=81&amp;height=28" frameBorder="0" scrolling="no" allowTransparency="true" style="border:none;width:81px;height:28px;overflow:hidden"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // Ждём загрузки jQuery
        function initCartForm() {
            if (typeof jQuery === 'undefined') {
                setTimeout(initCartForm, 100);
                return;
            }
            
            jQuery(document).ready(function($) {
                var formId = '#addToCartForm-@Model.Id';
                $(formId).off('submit').on('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
                
                $(formId + ' button[type="submit"]').off('click').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var form = $(formId);
                    var productId = @Model.Id;
                    var quantity = parseInt($('#quantity-@Model.Id').val()) || 1;
                    var token = form.find('input[name="__RequestVerificationToken"]').val();
                    
                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        dataType: 'json',
                        headers: {
                            'RequestVerificationToken': token
                        },
                        data: { 
                            productId: productId, 
                            quantity: quantity,
                            __RequestVerificationToken: token
                        },
                        success: function(response) {
                            if (response && response.success) {
                                if (typeof showToast === 'function') {
                                    showToast('Товар добавлен в корзину!', 'success');
                                } else {
                                    alert('Товар добавлен в корзину!');
                                }
                                updateCartCount();
                            }
                        },
                        error: function(xhr, status, error) {
                            if (typeof showToast === 'function') {
                                showToast('Ошибка при добавлении товара', 'error');
                            } else {
                                alert('Ошибка при добавлении товара');
                            }
                        }
                    });
                    
                    return false;
                });
                
                function updateCartCount() {
                    $.get('@Url.Action("GetCartCount", "Cart")', function(data) {
                        if (data && data.count !== undefined) {
                            $('#cart-count').text(data.count || 0);
                            $('.cart-quantity-cart').text(data.count || 0);
                        }
                    });
                }
            });
        }
        
        initCartForm();
    })();
</script>
