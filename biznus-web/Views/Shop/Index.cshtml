@model ShopViewModel
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<biznus_web.Controllers.ShopController> localizer
@{
    ViewData["Title"] = "Shop";
}

<!-- Заголовок страницы -->
<div class="page-title-section">
    <div class="container">
        <h1 class="page-title">@(localizer["ShopOurProducts"])</h1>
    </div>
</div>

<!-- Рекомендуемый товар -->
<div class="content-section featured-section">
    <div class="container">
        <div class="w-dyn-list">
            <div role="list" class="w-dyn-items">
                @if (Model.Products.Any())
                {
                    var featuredProduct = Model.Products.First();
                    <div role="listitem" class="w-dyn-item">
                        <a style="background-image:url('@Url.Content(featuredProduct.ImageUrl)')" asp-controller="Shop" asp-action="Product" asp-route-id="@featuredProduct.Id" class="featured-wrapper w-inline-block">
                            <div class="pill-2 badge primary featured">@(localizer["FeaturedItem"])</div>
                            <div class="feature-text-wrapper">
                                <h3 class="featured-item-name">@featuredProduct.Name</h3>
                                <div class="featured-price">$@featuredProduct.Price.ToString("F2") USD</div>
                            </div>
                            <div class="featured-gradient-overlay"></div>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Основная секция магазина -->
<div class="content-section">
    <div class="container">
        <div class="shop-page-wrapper">
            <!-- Меню категорий -->
            <div class="shop-category-menu">
                <h2 class="category-menu-heading">@(localizer["ShopByCategory"])</h2>
                <div class="w-dyn-list">
                    <div role="list" class="w-dyn-items">
                        <div role="listitem" class="category-menu-item w-dyn-item">
                            <a href="/Shop?category=Gift Cards" class="btn dark outline cat-menu w-button @(Model.SelectedCategory == "Gift Cards" ? "w--current" : "")">@(localizer["GiftCards"])</a>
                        </div>
                        <div role="listitem" class="category-menu-item w-dyn-item">
                            <a href="/Shop?category=Tents" class="btn dark outline cat-menu w-button @(Model.SelectedCategory == "Tents" ? "w--current" : "")">@(localizer["Tents"])</a>
                        </div>
                        <div role="listitem" class="category-menu-item w-dyn-item">
                            <a href="/Shop?category=Accessories" class="btn dark outline cat-menu w-button @(Model.SelectedCategory == "Accessories" ? "w--current" : "")">@(localizer["Accessories"])</a>
                        </div>
                        <div role="listitem" class="category-menu-item w-dyn-item">
                            <a href="/Shop?category=Packs" class="btn dark outline cat-menu w-button @(Model.SelectedCategory == "Packs" ? "w--current" : "")">@(localizer["Packs"])</a>
                        </div>
                        <div role="listitem" class="category-menu-item w-dyn-item">
                            <a href="/Shop" class="btn dark outline cat-menu w-button @(string.IsNullOrEmpty(Model.SelectedCategory) ? "w--current" : "")">@(localizer["AllProducts"])</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Список товаров -->
            <div class="shop-list">
                <div class="products-list-wrapper w-dyn-list">
                    <div role="list" class="products-list w-dyn-items">
                        @if (Model.Products.Any())
                        {
                            @foreach (var product in Model.Products)
                            {
                                <div role="listitem" class="w-dyn-item">
                                    <div class="shop-item-wrapper">
                                        <a asp-controller="Shop" asp-action="Product" asp-route-id="@product.Id" class="shop-item-link-wrapper w-inline-block">
                                            <div style="background-image:url('@Url.Content(product.ImageUrl)')" class="shop-image tumbler-1 narrow-list">
                                                @if (product.Price < 100)
                                                {
                                                    <div class="pill-2 badge primary sale">@(localizer["Sale"])</div>
                                                }
                                            </div>
                                            <div class="shop-details-wrapper">
                                                <div class="shop-details-left">
                                                    <div class="shop-item-name">@product.Name</div>
                                                    <div class="price-wrapper">
                                                        <div class="shop-item-price">$@product.Price.ToString("F2") USD</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                        <div class="shop-button-wrapper">
                                            <a asp-controller="Shop" asp-action="Product" asp-route-id="@product.Id" class="btn w-button">@(localizer["Details"])</a>
                                            @if (product.IsAvailable)
                                            {
                                                <form asp-controller="Cart" asp-action="Add" method="post" style="display: inline; margin-left: 0.5rem;" class="add-to-cart-form-@product.Id">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="productId" value="@product.Id" />
                                                    <input type="hidden" name="quantity" value="1" />
                                                    <button type="submit" class="btn outline w-button">@(localizer["AddToCart"])</button>
                                                </form>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-products">
                                <h2>@(localizer["NoProductsFound"])</h2>
                                <p>@(localizer["NoProductsDescription"])</p>
                                <a href="/Shop" class="btn w-button">@(localizer["ViewAllProducts"])</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        function initCartForms() {
            if (typeof jQuery === 'undefined') {
                setTimeout(initCartForms, 100);
                return;
            }
            
            jQuery(document).ready(function($) {
                $('[class^="add-to-cart-form-"]').each(function() {
                    var form = $(this);
                    form.off('submit').on('submit', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    });
                    
                    form.find('button[type="submit"]').off('click').on('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        var formData = form.serialize();
                        var token = form.find('input[name="__RequestVerificationToken"]').val();
                        
                        $.ajax({
                            url: form.attr('action'),
                            type: 'POST',
                            dataType: 'json',
                            headers: {
                                'RequestVerificationToken': token
                            },
                            data: formData,
                            success: function(response) {
                                if (response && response.success) {
                                    if (typeof showToast === 'function') {
                                        showToast('Товар добавлен в корзину!', 'success');
                                    } else {
                                        alert('Товар добавлен в корзину!');
                                    }
                                    updateCartCount();
                                }
                            },
                            error: function() {
                                if (typeof showToast === 'function') {
                                    showToast('Ошибка при добавлении товара', 'error');
                                } else {
                                    alert('Ошибка при добавлении товара');
                                }
                            }
                        });
                        
                        return false;
                    });
                });
                
                function updateCartCount() {
                    $.get('@Url.Action("GetCartCount", "Cart")', function(data) {
                        if (data && data.count !== undefined) {
                            $('#cart-count').text(data.count || 0);
                            $('.cart-quantity-cart').text(data.count || 0);
                        }
                    });
                }
            });
        }
        
        initCartForms();
    })();
</script>
